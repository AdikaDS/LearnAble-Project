name: Delete Old Deployments

on:
  workflow_dispatch: # Dijalankan secara manual dari GitHub UI

jobs:
  cleanup-deployments:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repo
      uses: actions/checkout@v3

    - name: Delete old deployments
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        REPO: ${{ github.repository }}
      run: |
        echo "Fetching deployments for $REPO"
        DEPLOYMENTS=$(curl -s -H "Authorization: token $GITHUB_TOKEN" \
          https://api.github.com/repos/$REPO/deployments \
          | jq -r '.[] | select(.environment=="production") | .id')

        echo "Found deployments:"
        echo "$DEPLOYMENTS"

        for DEPLOYMENT_ID in $DEPLOYMENTS; do
          echo "Attempting to delete deployment ID $DEPLOYMENT_ID"

          # Try deleting the deployment (only if no statuses)
          RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" -X DELETE \
            -H "Authorization: token $GITHUB_TOKEN" \
            https://api.github.com/repos/$REPO/deployments/$DEPLOYMENT_ID)

          if [ "$RESPONSE" -eq 204 ]; then
            echo "✅ Successfully deleted deployment $DEPLOYMENT_ID"
          else
            echo "⚠️ Failed to delete deployment $DEPLOYMENT_ID (status code: $RESPONSE)"
          fi
        done
